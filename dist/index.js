!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("cli-color")):"function"==typeof define&&define.amd?define(["cli-color"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).index=e(t.clc)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=e(t);const r={sFlag:"h",mFlag:"help",description:"print help",call:({parser:t})=>(t.usage(),!0)},n={sFlag:"v",mFlag:"version",description:"display version",call({options:t}){console.info(t.version)}},a=(t,e)=>s=>s.sFlag?s.sFlag===e:s.mFlag===t;return class{constructor(t={}){this.arguments=[],this.commands=[],this.argv=[],this.errors=[],this.final={},this.anyArgs=[],this.options=t,this.addArgument(Object.assign({},r)),this.options.version&&this.addArgument(Object.assign({},n))}checkArguments(t,e=null){const s={};t.forEach(((t,r)=>{var n;const a=t.sFlag||t.mFlag;if(a in s)throw new Error(`duplicate options '${a}' ${e?`from '${e.name}' command`:""}`);if(!t.sFlag&&!t.mFlag)throw new Error("sFlag or mFlag need to be set");if((null===(n=t.sFlag)||void 0===n?void 0:n.length)>1)throw new Error("sFlag need to be only one char");s[a]=!0}))}addArgument(t){this.arguments.push(t),this.checkArguments(this.arguments)}addCommand(t){var e;if(this.commands.filter((e=>e.name===t.name)).length>0)throw new Error(`Command '${t.name}' already set`);(null===(e=t.arguments)||void 0===e?void 0:e.length)&&this.checkArguments(t.arguments,t),this.commands.push(t)}convertType(t,e){if(t===Number){const t=Number(e);if(Number.isNaN(t))throw new Error("nedd valid number.");return t}if(t!==Boolean)return e;switch(e){case"true":case"yes":return!0;case"false":case"no":return!1;default:throw new Error("boolean type, choise are 'true' or 'false'")}}parseFlag(t,e,s){const r={_declare:e};if(e.sFlag&&(this.final[e.sFlag]=r),e.mFlag&&(this.final[e.mFlag]=r),!e.params||!e.params.length)return s+1;r.params=[];let n=0;for(;n<e.params.length;n++){const a=e.params[n];if(this.argv.length<=n+s+1){if(!("default"in a)){this.errors.push({text:e.description||`need ${e.params.length} arguments after flag "${t}".`,idxArgv:s});break}r.params[n]=a.default}else{const e=this.argv[s+n+1];try{if(a.validator){const t=a.validator(e);r.params[n]=t}else this.convertType(a.type,e)}catch(e){this.errors.push({text:`invalid arugments for flag "${t}", ${e.toString()}`,idxArgv:s+n+1});break}}}return s+n}_parseOption(t,e=0){let r=!1;const n=this.options.stopFlags||null;for(;e<this.argv.length;){const a=this.argv[e];if(a!==n)if(r||"-"!=a[0])this.anyArgs.push(a),e++;else{if("-"==a[1]){const r=a.substr(2),n=t.filter((t=>t.mFlag===r))[0];n?e=this.parseFlag(r,n,e):this.errors.push({text:`Found argument '${s.default.yellow(`--${r}`)}' which wasn't expected, or isn't valid in this context`,idxArgv:e})}else{if(1==a.length){this.errors.push({text:`Empty argument '${s.default.yellow("-")}' which wasn't expected.`,idxArgv:e}),e++;continue}let r=e;for(let n=1;n<a.length;n++){const o=a[n],i=t.filter((t=>t.sFlag==o))[0];i?r=this.parseFlag(o,i,r):this.errors.push({text:`Found argument '${s.default.yellow(`-${o}`)}' which wasn't expected, or isn't valid in this context.`,idxArgv:e,start:n,end:1})}e=r}e++}else r=!0,e++}return 0==this.errors.length}checkArgumentsCall(){const t=Object.keys(this.final);for(let e=0;e<t.length;e++){const s=this.final[t[e]];if(s._declare.call)return s._declare.call}return null}context(){return{flags:this.final,arguments:this.anyArgs,options:this.options,parser:this}}parseOptions(){if(!this._parseOption(this.arguments))return!1;const t=this.checkArgumentsCall();return t&&t(this.context()),!0}parseCommand(){if(0==this.argv.length)return this.usage(),!1;const t=this.argv[0],e=this.commands.filter((e=>e.name===t))[0];if(!e)return this.errors.push({text:`no such subcommand: '${s.default.yellow(t)}''`,idxArgv:0}),!1;e.arguments&&e.arguments.length||(e.arguments=[]);const n=[...e.arguments||[]];this.arguments.forEach((t=>{n.filter(a(t.mFlag,t.sFlag))[0]||n.push(t)}));if(!e.arguments.filter(a("help","h"))[0]){const t=Object.assign({},r);t.call=({parser:t,cmd:e})=>{t.commandUsage(e)},e.arguments.push(t)}if(!this._parseOption(n,1))return!1;const o=this.context();o.cmd=e;const i=this.checkArgumentsCall();return i?i(o):e.call(o),!0}parse(t){let e;return this.argv=t,e=this.commands.length>0?this.parseCommand():this.parseOptions(),e||this.printError(),e}printError(){const t=this.argv.join(" ")+"\n";let e=this.errors;this.options.maxError&&(e=[...this.errors].splice(0,this.options.maxError));let r="";e.forEach((e=>{r+=`${s.default.red(s.default.bold("error"))}: ${e.text}\n`,r+=t;let n=e.idxArgv;for(let t=0;t<e.idxArgv;t++)n+=this.argv[t].length;const a=this.argv[e.idxArgv].length;let o;if(null!=e.start&&null!=e.end){o=s.default.red("~".repeat(e.start))+s.default.red(s.default.bold("^".repeat(e.end)));const t=a-(e.start+e.end);t>0&&(o+=s.default.red("~".repeat(t)))}else o=s.default.red(s.default.bold("^".repeat(a)));r+=`${" ".repeat(n)}${o}\n`})),r+=`total errors: ${s.default.red(s.default.bold(this.errors.length))}`,console.error(r)}formatOptions(t,e="Options:"){const s={},r=t.reduce(((t,e)=>{var r;return e.mFlag?(s[e.mFlag]=e.mFlag.length,e.params&&(s[e.mFlag]+=(null===(r=e.params)||void 0===r?void 0:r.reduce(((t,e)=>t+e.type.constructor.name.length),0))+1),Math.max(t,s[e.mFlag])):t}),0),n=[e];return t.reduce(((t,e)=>{let n=e.sFlag?` -${e.sFlag}`:"   ";return n+=e.sFlag&&e.mFlag?", ":"  ",e.mFlag&&(n+=`--${e.mFlag} `,e.params&&(n+=e.params.reduce(((t,e)=>`${t}${e.type.constructor.name} `),""))),n+=" ".repeat((e.mFlag?r-s[e.mFlag]:r+3)+1),t.push(`${n}${e.description||"no information."}`),t}),n)}formatSubCommands(t){const e=t.reduce(((t,e)=>Math.max(t,e.name.length)),0);return t.reduce(((t,s)=>(t.push(`  ${s.name} ${" ".repeat(e-s.name.length+2)}${s.description}`),t)),["Management Commands:"])}commandUsage(t){var e;let s="";s+=`Usage: ${(null===(e=this.options)||void 0===e?void 0:e.name)||""} ${t.name} `,this.options.progStatus?s+=this.options.progStatus:s+="[OPTIONS]\n\n",s+=t.description,this.arguments&&(s+="\n\n"+this.formatOptions(this.arguments,"Global options:").join("\n")),t.arguments&&(s+="\n\n"+this.formatOptions(t.arguments,"Command options:").join("\n")),this.options.footer&&(s+=`\n\n${this.options.footer}`),console.log(s)}usage(){var t;let e="";e+=`Usage: ${(null===(t=this.options)||void 0===t?void 0:t.name)||""} `,this.options.progStatus?e+=this.options.progStatus:e+=`[OPTIONS] ${this.commands.length>0?"COMMAND":""}\n\n`,this.options.description&&(e+=this.options.description),this.arguments.length&&(e+="\n\n"+this.formatOptions(this.arguments).join("\n")),this.commands.length&&(e+="\n\n"+this.formatSubCommands(this.commands).join("\n")),this.options.footer&&(e+=`\n\n${this.options.footer}`),console.log(e)}}}));
